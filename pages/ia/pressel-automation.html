<!doctype html>
<html lang="pt">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pressel Automation - CMS</title>
    <style>
      html, body { overscroll-behavior: none; }
      body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; min-height: 100vh; }
      .sidebar { width: 240px; background: #333; color: #fff; padding: 20px; box-sizing: border-box; }
      .sidebar h2 { margin-top: 0; }
      .sidebar form { margin-bottom: 20px; }
      .sidebar label { display: block; margin-bottom: 5px; font-size: 0.9em; }
      .sidebar select { width: 100%; padding: 5px; margin-bottom: 20px; }
      .sidebar nav ul { list-style: none; padding: 0; }
      .sidebar nav ul li { margin: 10px 0; }
      .sidebar nav ul li a { color: #fff; text-decoration: none; padding: 5px 10px; display: block; border-radius: 4px; }
      .sidebar nav ul li a.active, .sidebar nav ul li a:hover { background-color: #555; }
      .content { flex-grow: 1; padding: 20px; }
      .flash { padding: 10px; background: #e0ffe0; border: 1px solid #0a0; margin-bottom: 10px; border-radius: 4px; }
      .header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
      .header h1 { margin: 0; }
      .button {
          display: inline-block;
          padding: 8px 12px;
          background: #007BFF;
          color: #fff;
          text-decoration: none;
          border-radius: 4px;
          font-size: 0.9em;
          margin: 5px 0;
          border: none;
          cursor: pointer;
      }
      .button:hover { background: #0056b3; }
      .button.success { background: #28a745; }
      .button.success:hover { background: #218838; }
      .button.danger { background: #dc3545; }
      .button.danger:hover { background: #c82333; }
      @media (max-width: 600px) {
          .sidebar { width: 100%; padding: 10px; }
          .content { padding: 10px; }
      }
      form label { display: block; margin-bottom: 10px; font-weight: bold; }
      form input[type="text"], form input[type="email"], form input[type="password"], form select, form textarea, form input[type="date"] {
          width: 100%; padding: 8px; margin-top: 4px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
      }
      form input[type="submit"] { background-color: #28a745; border: none; color: white; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 4px; }
      form input[type="submit"]:hover { background-color: #218838; }
      .section { background: #f8f9fa; padding: 20px; margin-bottom: 20px; border-radius: 8px; border-left: 4px solid #007BFF; }
      .section h3 { margin-top: 0; color: #007BFF; }
      .section.purple { border-left-color: #6f42c1; }
      .section.purple h3 { color: #6f42c1; }
      .section.green { border-left-color: #28a745; }
      .section.green h3 { color: #28a745; }
      .tabs { display: flex; margin-bottom: 20px; }
      .tab { padding: 10px 20px; background: #e9ecef; border: none; cursor: pointer; border-radius: 4px 4px 0 0; margin-right: 5px; }
      .tab.active { background: #007BFF; color: white; }
      .tab-content { display: none; }
      .tab-content.active { display: block; }
      .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 8px; margin: 20px 0; }
      .upload-area.dragover { border-color: #007BFF; background: #f8f9fa; }
      .preview { background: white; padding: 15px; border-radius: 4px; margin-top: 10px; border: 1px solid #ddd; }
      .preview h4 { margin-top: 0; color: #007BFF; }
      .preview p { color: #666; margin: 5px 0; }
      .loading { display: none; text-align: center; padding: 20px; }
      .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #007BFF; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0; }
      .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>CMS Admin</h2>
        <form id="organization-selector" method="get" action="/">
            <label for="organization-select">Selecionar Organiza√ß√£o</label>
            <select id="organization-select" name="organization_id">
                <!-- Options ser√£o carregadas via AJAX -->
            </select>
        </form>
        <form id="site-selector" method="get" action="/">
            <label for="site-select">Selecionar Site</label>
            <select id="site-select" name="site_id">
                <!-- Options ser√£o carregados via AJAX -->
            </select>
        </form>
        <nav>
            <ul>
                <li><a href="/">Pages</a></li>
                <li><a href="/pages-with-templates">Pages com Templates</a></li>
                <li><a href="/users">Usu√°rios</a></li>
                <li><a href="/categories">Categorias</a></li>
                <li><a href="/sites">Sites</a></li>
                <li><a href="/media/manage">M√≠dia</a></li>
                <li><a href="/templates">Templates</a></li>
                <li><a href="/themes">Themes</a></li>
                <li><a href="/organizations">Organiza√ß√µes</a></li>
                <li style="border-left: white solid 5px;padding: 8px;border-radius: 5px;border-right: none;">
                    <span>IA</span>
                    <ul>
                        <li><a href="/queue">Fila</a></li>
                        <li><a href="/ai-create">Gerar Page</a></li>
                        <li><a href="/ai-institutional-pages">Pages Institucionais</a></li>
                        <li><a href="/youtube-channel-create">Canal YouTube</a></li>
                        <li><a href="/ai-regenerate-pages">IA Refazer</a></li>
                        <li><a href="/quiz-create">Gerar Quiz</a></li>
                        <li><a href="/generate_images">Gerar Imagens</a></li>
                        <li><a href="/fb_ads_projects">Criativos Facebook Ads</a></li>
                        <li><a href="/pressel-automation" class="active">Pressel Automation</a></li>
                    </ul>
                </li>
                <li style="border-left: white solid 5px;padding: 8px;border-radius: 5px;border-right: none;">
                    <span>Tools</span>
                    <ul>
                        <li><a href="/seo/generate">Gerar SEO (Sitemap/Robots)</a></li>
                        <li><a href="/bulk-generate" style="color: #28a745;">üöÄ Gera√ß√£o em Massa</a></li>
                        <li><a href="/rebuild">Reconstruir Pages</a></li>
                        <li><a href="/import_pages">Importar Pages</a></li>
                        <li><a href="/generate_all_links">Gerar links</a></li>
                        <li><a href="/duplicate-page">Duplicar P√°gina</a></li>
                        <li><a href="/delete-pages">Apagar</a></li>
                    </ul>
                </li>
                <li style="border-left: red solid 3px; padding: 8px; border-radius: 5px; border-right: none; margin-bottom: 10px;">
                    <span style="color: #ff6b6b; font-weight: bold;">Administra√ß√£o</span>
                    <ul>
                        <li><a href="#" onclick="logoutAllSessions()" style="color: #ff6b6b;">üö® Deslogar Todas as Sess√µes</a></li>
                    </ul>
                </li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </nav>
    </div>
    <div class="content">
        <div class="header">
            <h1>üöÄ Pressel Automation</h1>
            <div class="actions">
                <a class="button" href="/ai-create">Voltar para IA</a>
            </div>
        </div>
        
        <div class="section">
            <h3>üìã Como funciona</h3>
            <p>Crie p√°ginas Pressel automaticamente a partir de JSON gerado pelo ChatGPT ou texto convertido. O sistema integra com WordPress usando o plugin Pressel Automation.</p>
            <ol>
                <li><strong>Cole o texto do ChatGPT</strong> ou fa√ßa upload de um JSON estruturado</li>
                <li><strong>Configure o modelo</strong> e op√ß√µes personalizadas</li>
                <li><strong>Selecione o site WordPress</strong> de destino</li>
                <li><strong>Clique em criar</strong> e a p√°gina ser√° gerada automaticamente</li>
            </ol>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('text-conversion')">Convers√£o de Texto</button>
            <button class="tab" onclick="showTab('json-processing')">Processar JSON</button>
        </div>

        <!-- Convers√£o de Texto para JSON -->
        <div id="text-conversion" class="tab-content active">
            <div class="section purple">
                <h3>ü§ñ Convers√£o de Texto para JSON</h3>
                <p>Cole o texto gerado pelo ChatGPT e configure as op√ß√µes abaixo:</p>
                
                <form id="text-conversion-form">
                    <label for="chatgpt-text">Texto do ChatGPT:</label>
                    <textarea id="chatgpt-text" name="text" rows="8" placeholder="Cole aqui o texto completo gerado pelo ChatGPT..."></textarea>
                    
                    <label for="page-model">Modelo de P√°gina:</label>
                    <select id="page-model" name="model">
                        <option value="modelo_v1">Modelo V1 (Brasileiro)</option>
                    </select>
                    
                    <label for="page-slug">Slug da P√°gina (opcional):</label>
                    <input type="text" id="page-slug" name="slug" placeholder="exemplo: minha-pagina-pressel">
                    
                    <div class="section green">
                        <h4>Configura√ß√µes Personalizadas (Opcional)</h4>
                        
                        <label for="button-type">Tipo de Bot√£o:</label>
                        <select id="button-type" name="buttonType">
                            <option value="auto">Auto-detectar do texto</option>
                            <option value="normal">Normal</option>
                            <option value="rewarded">Rewarded</option>
                        </select>
                        
                        <label for="button-color">Cor do Bot√£o:</label>
                        <input type="color" id="button-color" name="buttonColor" value="#2352AE">
                        
                        <label for="button1-url">Link Bot√£o 1:</label>
                        <input type="url" id="button1-url" name="button1Url" placeholder="https://exemplo.com">
                        
                        <label for="button2-url">Link Bot√£o 2:</label>
                        <input type="url" id="button2-url" name="button2Url" placeholder="https://exemplo.com">
                        
                        <label for="button3-url">Link Bot√£o 3:</label>
                        <input type="url" id="button3-url" name="button3Url" placeholder="https://exemplo.com">
                    </div>
                    
                    <button type="submit" class="button success">üîÑ Converter Texto e Criar P√°gina</button>
                </form>
            </div>
        </div>

        <!-- Processar JSON -->
        <div id="json-processing" class="tab-content">
            <div class="section purple">
                <h3>üìÑ Processar JSON</h3>
                <p>Fa√ßa upload de um arquivo JSON ou cole diretamente o JSON estruturado:</p>
                
                <div class="tabs">
                    <button class="tab active" onclick="showJsonTab('upload')">Upload de Arquivo</button>
                    <button class="tab" onclick="showJsonTab('paste')">Colar JSON</button>
                </div>
                
                <!-- Upload de Arquivo -->
                <div id="json-upload" class="tab-content active">
                    <div class="upload-area" id="upload-area">
                        <div style="font-size: 48px; color: #ccc; margin-bottom: 10px;">‚òÅÔ∏è</div>
                        <p>Arraste e solte um arquivo JSON aqui ou clique para selecionar</p>
                        <input type="file" id="json-file" accept=".json" style="display: none;">
                        <button type="button" class="button" onclick="document.getElementById('json-file').click()">Selecionar Arquivo</button>
                    </div>
                </div>
                
                <!-- Colar JSON -->
                <div id="json-paste" class="tab-content">
                    <label for="json-text">JSON Estruturado:</label>
                    <textarea id="json-text" name="json" rows="10" placeholder="Cole aqui o JSON estruturado..."></textarea>
                </div>
                
                <button type="button" class="button success" onclick="processJson()">üöÄ Processar JSON e Criar P√°gina</button>
            </div>
        </div>

        <!-- Preview e Resultados -->
        <div id="preview-section" class="section" style="display: none;">
            <h3>üëÅÔ∏è Preview da P√°gina</h3>
            <div id="preview-content"></div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Processando... Aguarde alguns segundos.</p>
        </div>

        <!-- Mensagens -->
        <div id="messages"></div>
    </div>

    <script>
        // Vari√°veis globais
        let currentSite = localStorage.getItem('selected_site') || '';
        let currentOrg = localStorage.getItem('selected_organization') || '';

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadOrganizations();
            loadSites();
        });

        // Carregar organiza√ß√µes
        function loadOrganizations() {
            fetch('/api/organizations')
                .then(response => response.json())
                .then(data => {
                    const orgSelect = document.getElementById('organization-select');
                    orgSelect.innerHTML = '';
                    data.organizations.forEach(function(org) {
                        const option = document.createElement('option');
                        option.value = org._id;
                        option.text = org.name;
                        orgSelect.appendChild(option);
                    });
                    
                    if (currentOrg) {
                        orgSelect.value = currentOrg;
                    }
                });
        }

        // Carregar sites
        function loadSites() {
            fetch('/api/sites?organization_id=' + currentOrg)
                .then(response => response.json())
                .then(data => {
                    const siteSelect = document.getElementById('site-select');
                    siteSelect.innerHTML = '';
                    data.sites.forEach(function(site) {
                        const option = document.createElement('option');
                        option.value = site._id;
                        option.text = site.name;
                        siteSelect.appendChild(option);
                    });
                    
                    if (currentSite) {
                        siteSelect.value = currentSite;
                    }
                });
        }

        // Mostrar/ocultar tabs
        function showTab(tabName) {
            // Ocultar todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showJsonTab(tabName) {
            // Ocultar todas as tabs JSON
            document.querySelectorAll('#json-upload, #json-paste').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.textContent.includes('Upload') || tab.textContent.includes('Colar')) {
                    tab.classList.remove('active');
                }
            });
            
            // Mostrar tab selecionada
            document.getElementById('json-' + tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Formul√°rio de convers√£o de texto
        document.getElementById('text-conversion-form').addEventListener('submit', function(e) {
            e.preventDefault();
            convertText();
        });

        // Converter texto
        async function convertText() {
            const formData = new FormData(document.getElementById('text-conversion-form'));
            const data = Object.fromEntries(formData);
            
            if (!data.text || data.text.trim().length === 0) {
                showMessage('Por favor, insira o texto do ChatGPT.', 'error');
                return;
            }

            showLoading(true);
            
            try {
                const response = await fetch('/api/pressel/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showPreview(result.data);
                    showMessage('Texto convertido com sucesso! Clique em "Criar P√°gina" para finalizar.', 'success');
                } else {
                    showMessage('Erro ao converter texto: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('Erro de conex√£o: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Processar JSON
        async function processJson() {
            let jsonData;
            
            // Verificar se √© upload de arquivo ou texto
            const fileInput = document.getElementById('json-file');
            const textArea = document.getElementById('json-text');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const text = await file.text();
                jsonData = JSON.parse(text);
            } else if (textArea.value.trim()) {
                jsonData = JSON.parse(textArea.value);
            } else {
                showMessage('Por favor, selecione um arquivo ou cole o JSON.', 'error');
                return;
            }

            await createPage(jsonData);
        }

        // Criar p√°gina
        async function createPage(jsonData) {
            if (!currentSite) {
                showMessage('Por favor, selecione um site.', 'error');
                return;
            }

            showLoading(true);
            
            try {
                const response = await fetch('/api/pressel/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        siteId: currentSite,
                        json: jsonData,
                        slug: document.getElementById('page-slug').value
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(`P√°gina criada com sucesso! <a href="${result.data.view_link}" target="_blank">Ver p√°gina</a> | <a href="${result.data.edit_link}" target="_blank">Editar</a>`, 'success');
                } else {
                    showMessage('Erro ao criar p√°gina: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('Erro de conex√£o: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Mostrar preview
        function showPreview(data) {
            const previewSection = document.getElementById('preview-section');
            const previewContent = document.getElementById('preview-content');
            
            previewContent.innerHTML = `
                <div class="preview">
                    <h4>${data.json.page_title}</h4>
                    <p><strong>Modelo:</strong> ${data.model}</p>
                    <p><strong>Descri√ß√£o:</strong> ${data.preview.description}</p>
                    <p><strong>Bot√µes:</strong> ${data.preview.buttons.map(b => b.text).join(', ')}</p>
                </div>
                <button class="button success" onclick="createPage(${JSON.stringify(data.json).replace(/"/g, '&quot;')})">üöÄ Criar P√°gina</button>
            `;
            
            previewSection.style.display = 'block';
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Mostrar mensagens
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.innerHTML = message;
            messagesDiv.appendChild(messageDiv);
            
            // Remover mensagem ap√≥s 5 segundos
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Upload de arquivo
        document.getElementById('json-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('upload-area').innerHTML = `
                    <div style="font-size: 48px; color: #28a745; margin-bottom: 10px;">‚úÖ</div>
                    <p><strong>Arquivo selecionado:</strong> ${file.name}</p>
                    <p>Tamanho: ${(file.size / 1024).toFixed(2)} KB</p>
                `;
            }
        });

        // Drag and drop
        const uploadArea = document.getElementById('upload-area');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('json-file').files = files;
                document.getElementById('json-file').dispatchEvent(new Event('change'));
            }
        });

        // Event listeners para seletores
        document.getElementById('organization-select').addEventListener('change', function() {
            currentOrg = this.value;
            localStorage.setItem('selected_organization', currentOrg);
            loadSites();
        });

        document.getElementById('site-select').addEventListener('change', function() {
            currentSite = this.value;
            localStorage.setItem('selected_site', currentSite);
        });
    </script>
</body>
</html>

