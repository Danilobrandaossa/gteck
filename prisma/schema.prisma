// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  settings    String   @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users User[]
  sites Site[]

  // FASE 3: Novos relacionamentos IA-native
  embeddings     Embedding[]
  aiInteractions AIInteraction[]
  aiMetrics      AIMetric[]
  aiPrompts      AIPrompt[]

  // FASE 6: Chat sessions
  chatSessions ChatSession[]

  // FASE 6: AI Response Cache
  aiResponseCaches AIResponseCache[]

  // FASE 7: Embedding Chunks
  embeddingChunks EmbeddingChunk[]

  @@map("organizations")
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  name        String?
  password    String?
  role        String    @default("viewer") // admin, editor, author, viewer
  avatar      String?
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  pages      Page[]
  aiContents AIContent[]

  // FASE 3: Novos relacionamentos IA-native
  aiInteractions   AIInteraction[]
  aiMetrics        AIMetric[]
  aiPromptsCreated AIPrompt[]      @relation("AIPromptCreatedBy")
  aiPromptsUpdated AIPrompt[]      @relation("AIPromptUpdatedBy")

  // FASE 6: Chat sessions
  chatSessions ChatSession[]

  @@map("users")
}

model Site {
  id          String   @id @default(cuid())
  name        String
  url         String
  description String?
  logo        String?
  settings    String   @default("{}")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  pages          Page[]
  categories     Category[]
  media          Media[]
  aiContents     AIContent[]
  aiPluginConfig AIPluginConfig?

  // FASE 3: Novos relacionamentos IA-native
  embeddings     Embedding[]
  aiInteractions AIInteraction[]
  aiMetrics      AIMetric[]
  aiPrompts      AIPrompt[]

  // FASE 6: Chat sessions
  chatSessions ChatSession[]

  // FASE 6: AI Response Cache
  aiResponseCaches AIResponseCache[]

  // FASE 7: Embedding Chunks
  embeddingChunks EmbeddingChunk[]

  // FASE C: WordPress Integration (WordPress Sync)
  wpBaseUrl      String? // URL do site WordPress
  wpAuthType     String? // "basic", "application_password", "jwt", "oauth"
  wpUsername     String? // Username para autentica√ß√£o WordPress
  wpPasswordHash String? // Senha criptografada (AES-256-CBC)
  wpToken        String? // Token para JWT/OAuth
  wpConfigured   Boolean   @default(false) // Se credenciais WordPress est√£o configuradas
  wpLastSyncAt   DateTime? // √öltima sincroniza√ß√£o com WordPress

  @@map("sites")
}

model Page {
  id             String    @id @default(cuid())
  title          String
  slug           String
  content        String?
  excerpt        String?
  status         String    @default("draft") // draft, published, archived
  featuredImage  String?
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?
  customFields   String    @default("{}")
  publishedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  templateId String?
  template   Template? @relation(fields: [templateId], references: [id], onDelete: SetNull)

  // FASE 3: Campos aditivos para embeddings (opcionais)
  embeddingGeneratedAt DateTime?
  embeddingModel       String?
  embeddingVersion     Int       @default(1)

  // FASE 3: Novos relacionamentos IA-native
  embeddings     Embedding[]
  aiInteractions AIInteraction[]

  // FASE 7: Embedding Chunks
  embeddingChunks EmbeddingChunk[]

  // FASE C: WordPress Integration (WordPress Sync)
  wpPostId   Int? // ID do post/page no WordPress
  wpSiteUrl  String? // URL do site WordPress de origem
  wpSyncedAt DateTime? // √öltima sincroniza√ß√£o com WordPress
  acfFields  String?   @default("{}") // Campos ACF em JSON

  @@unique([siteId, slug])
  @@unique([siteId, wpPostId], map: "pages_site_wp_post_unique")
  @@map("pages")
}

model Template {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  content     String
  fields      String   @default("[]")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  pages Page[]

  // FASE 3: Campos aditivos para embeddings (opcionais)
  embeddingGeneratedAt DateTime?
  embeddingModel       String?
  embeddingVersion     Int       @default(1)

  // FASE 3: Novos relacionamentos IA-native
  embeddings     Embedding[]
  EmbeddingChunk EmbeddingChunk[]

  @@map("templates")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  parentId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  pages Page[]

  // FASE C: WordPress Integration (WordPress Sync)
  wpTermId  Int? // ID do term (category) no WordPress
  wpSiteUrl String? // URL do site WordPress de origem

  @@unique([siteId, slug])
  @@unique([siteId, wpTermId], map: "categories_site_wp_term_unique")
  @@map("categories")
}

model Media {
  id           String   @id @default(cuid())
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  alt          String?
  caption      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // FASE C: WordPress Integration (WordPress Sync)
  wpMediaId Int? // ID do attachment no WordPress
  wpSiteUrl String? // URL do site WordPress de origem

  @@unique([siteId, wpMediaId], map: "media_site_wp_media_unique")
  @@map("media")
}

model QueueJob {
  id          String    @id @default(cuid())
  type        String
  status      String    @default("pending") // pending, processing, completed, failed
  data        String
  result      String?
  error       String?
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  processedAt DateTime?

  // FASE 7 ETAPA 4: Campos de lock/heartbeat para m√∫ltiplas inst√¢ncias
  lockedBy            String? // ID da inst√¢ncia do worker
  lockedAt            DateTime? // Quando o lock foi adquirido
  lockExpiresAt       DateTime? // TTL do lock (quando expira)
  lastHeartbeatAt     DateTime? // √öltimo heartbeat (worker vivo)
  processingStartedAt DateTime? // Quando come√ßou o processamento (m√©tricas)

  @@index([status], map: "queue_jobs_status_idx")
  @@index([createdAt], map: "queue_jobs_created_at_idx")
  @@index([status, lockExpiresAt], map: "queue_jobs_status_lock_idx") // Para recupera√ß√£o de stuck jobs
  @@index([lockedBy], map: "queue_jobs_locked_by_idx") // Para rastreamento por worker
  @@map("queue_jobs")
}

model WordPressDiagnostic {
  id              String   @id @default(cuid())
  dataExecucao    DateTime
  resultado       String // Armazena todo o resultado do diagn√≥stico
  acoesCorrigidas Boolean  @default(false)
  feedbackUsuario String?
  siteUrl         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("wordpress_diagnostics")
}

model AIContent {
  id                     String  @id @default(cuid())
  title                  String
  slug                   String? // Slug do post (URL amig√°vel)
  excerpt                String? // Resumo / Descri√ß√£o curta
  content                String? // Conte√∫do completo do post
  status                 String  @default("draft") // draft, published, error, generating
  language               String  @default("pt-BR") // Idioma
  category               String? // Categoria
  tags                   String? // Tags separadas por v√≠rgula
  keywords               String? // Palavra-chave principal
  secondaryKeywords      String? // Palavras-chave secund√°rias (JSON array)
  aiModel                String? // Modelo de IA usado (gpt-4, claude, etc)
  prompt                 String? // Prompt original usado para gerar
  additionalInstructions String? // Instru√ß√µes adicionais para regenera√ß√£o
  generationConfig       String? @default("{}") // Configura√ß√µes de gera√ß√£o (JSON)
  wordCount              Int? // Quantidade de palavras
  errorMessage           String? // Mensagem de erro (se status = error)
  wordpressPostId        Int? // ID do post no WordPress (se publicado)
  wordpressUrl           String? // URL do post no WordPress

  // SEO e Meta
  metaDescription  String? // Meta descri√ß√£o para SEO
  featuredImage    String? // URL da imagem destacada
  featuredImageAlt String? // Texto alternativo da imagem destacada

  // Rela√ß√µes
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  authorId String?
  author   User?   @relation(fields: [authorId], references: [id], onDelete: SetNull)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?
  scheduledAt DateTime? // Data de agendamento (se agendado)

  history AIContentHistory[]

  // FASE 3: Campos aditivos para embeddings (opcionais)
  embeddingGeneratedAt DateTime?
  embeddingModel       String?
  embeddingVersion     Int       @default(1)

  // FASE 3: Novos relacionamentos IA-native
  embeddings     Embedding[]
  aiInteractions AIInteraction[]

  // FASE 7: Embedding Chunks
  embeddingChunks EmbeddingChunk[]

  @@index([siteId], map: "ai_content_site_id_idx")
  @@index([status], map: "ai_content_status_idx")
  @@index([siteId, status], map: "ai_content_site_status_idx")
  @@index([authorId], map: "ai_content_author_idx")
  @@map("ai_content")
}

model AIPluginConfig {
  id            String   @id @default(cuid())
  siteId        String   @unique
  site          Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  apiKey        String? // API Key do plugin
  webhookUrl    String? // URL do webhook no WordPress
  webhookSecret String? // Secret para valida√ß√£o HMAC
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("ai_plugin_config")
}

// FASE F.4: Sync Conflicts
model SyncConflict {
  id                String    @id @default(cuid())
  organizationId    String
  siteId            String
  entityType        String // 'page', 'post', 'media', 'term'
  wpId              Int
  localId           String
  conflictType      String // 'local_newer', 'wp_newer', 'diverged'
  detectedAt        DateTime  @default(now())
  localSnapshotJson String    @default("{}")
  wpSnapshotJson    String    @default("{}")
  resolutionStatus  String    @default("open") // 'open', 'resolved', 'ignored'
  resolvedAt        DateTime?
  resolvedBy        String?
  resolutionNote    String?

  @@index([organizationId, siteId])
  @@index([entityType, wpId])
  @@index([resolutionStatus])
  @@map("sync_conflicts")
}

model AIContentHistory {
  id        String    @id @default(cuid())
  contentId String
  content   AIContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  action    String // generate, edit, publish, unpublish, delete, regenerate
  prompt    String? // Prompt usado (se aplic√°vel)
  metadata  String? // Metadados adicionais (JSON)

  // FASE 3: Campos aditivos para m√©tricas de IA (opcionais)
  tokensUsed      Int?
  costUSD         Float?
  durationMs      Int?
  modelUsed       String?
  providerUsed    String?
  aiInteractionId String?
  aiInteraction   AIInteraction? @relation(fields: [aiInteractionId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@map("ai_content_history")
}

// ============================================
// FASE 3: NOVAS TABELAS IA-NATIVE
// ============================================

// üß† 1. Embedding - Armazena vetores de conte√∫do
model Embedding {
  id String @id @default(cuid())

  // Relacionamento com conte√∫do (um embedding pode ser de Page, AIContent ou Template)
  pageId String?
  page   Page?   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  aiContentId String?
  aiContent   AIContent? @relation(fields: [aiContentId], references: [id], onDelete: Cascade)

  templateId String?
  template   Template? @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Multi-tenancy (OBRIGAT√ìRIO - garantia de isolamento)
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  organizationId String // Denormalizado para performance (evita JOINs em busca vetorial)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Dados do embedding (pgvector)
  // Nota: Prisma n√£o suporta nativamente vector, usamos Unsupported e gerenciamos via SQL raw
  embedding  Unsupported("vector(1536)") // pgvector - OpenAI ada-002 padr√£o (1536 dimens√µes)
  model      String                      @default("text-embedding-ada-002") // Modelo usado para gerar embedding
  dimensions Int                         @default(1536) // Dimens√µes do vetor

  // Metadados
  sourceType  String // "page", "ai_content", "template" (tipo de conte√∫do origem)
  contentHash String // Hash SHA-256 do conte√∫do original (evitar duplicatas)
  language    String @default("pt-BR")

  // Versionamento
  version  Int     @default(1) // Vers√£o do embedding (incrementa se conte√∫do mudar)
  isActive Boolean @default(true) // Embedding ativo ou obsoleto

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // √çndices para performance e isolamento multi-tenant
  @@index([siteId, sourceType, isActive], name: "embedding_site_source_active_idx")
  @@index([organizationId, sourceType], name: "embedding_org_source_idx")
  @@index([contentHash, model, version], name: "embedding_hash_model_version_idx")
  @@index([model, dimensions], name: "embedding_model_dimensions_idx")
  @@map("embeddings")
}

// ü§ñ 2. AIInteraction - Rastreia TODA intera√ß√£o com IA
model AIInteraction {
  id String @id @default(cuid())

  // Multi-tenancy (OBRIGAT√ìRIO)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  siteId String?
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: SetNull)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Relacionamento com conte√∫do (opcional - nem toda intera√ß√£o tem conte√∫do associado)
  aiContentId String?
  aiContent   AIContent? @relation(fields: [aiContentId], references: [id], onDelete: SetNull)

  pageId String?
  page   Page?   @relation(fields: [pageId], references: [id], onDelete: SetNull)

  // Tipo de intera√ß√£o
  type   String // "rag_query", "content_generation", "regeneration", "diagnostic", "suggestion", "editing_review"
  status String @default("pending") // "pending", "processing", "completed", "failed"

  // Prompt e contexto
  prompt        String // Prompt original do usu√°rio
  promptVersion String? // Vers√£o do prompt usado (refer√™ncia a AIPrompt.id)
  context       String? @default("{}") // JSON - contexto usado (RAG chunks, etc)

  // Modelo usado
  provider    String // "openai", "gemini", "claude"
  model       String // "gpt-4o-mini", "gemini-2.0-flash", "claude-3-sonnet", etc
  temperature Float? @default(0.7)
  maxTokens   Int?

  // Resposta
  response     String? // Resposta da IA
  finishReason String? // "stop", "length", "content_filter", "function_call", etc

  // M√©tricas de tokens
  promptTokens     Int?
  completionTokens Int?
  totalTokens      Int?

  // M√©tricas de custo
  costUSD Float? // Custo em USD
  costBRL Float? // Custo em BRL (se aplic√°vel)

  // M√©tricas de performance
  durationMs          Int? // Tempo total em milissegundos
  embeddingDurationMs Int? // Tempo para gerar/buscar embeddings (se aplic√°vel)
  aiCallDurationMs    Int? // Tempo da chamada √† IA

  // RAG espec√≠fico
  ragUsed                Boolean @default(false)
  ragChunksCount         Int? // Quantidade de chunks usados no contexto RAG
  ragSimilarityThreshold Float?  @default(0.7) // Threshold de similaridade usado na busca

  // Erros
  errorMessage String?
  errorCode    String?
  retryCount   Int     @default(0)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relacionamento com hist√≥rico
  aiContentHistories AIContentHistory[]

  // FASE 6: Relacionamento com mensagens de chat
  chatMessages ChatMessage[]

  // √çndices para performance e isolamento multi-tenant
  @@index([organizationId, type, status], name: "ai_interaction_org_type_status_idx")
  @@index([siteId, createdAt], name: "ai_interaction_site_created_idx")
  @@index([userId, createdAt], name: "ai_interaction_user_created_idx")
  @@index([provider, model], name: "ai_interaction_provider_model_idx")
  @@index([createdAt], name: "ai_interaction_created_at_idx")
  @@map("ai_interactions")
}

// üìä 3. AIMetric - M√©tricas agregadas (performance para dashboards)
model AIMetric {
  id String @id @default(cuid())

  // Multi-tenancy (opcionais para permitir agrega√ß√£o em diferentes n√≠veis)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  siteId String?
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Agrega√ß√£o temporal
  period      String // "hour", "day", "week", "month"
  periodStart DateTime // In√≠cio do per√≠odo
  periodEnd   DateTime // Fim do per√≠odo

  // Agrega√ß√£o por tipo
  type     String? // "rag_query", "content_generation", "regeneration", etc (null = todos os tipos)
  provider String? // "openai", "gemini", "claude", etc (null = todos os providers)
  model    String? // Modelo espec√≠fico (null = todos os modelos)

  // M√©tricas agregadas
  totalRequests      Int @default(0)
  successfulRequests Int @default(0)
  failedRequests     Int @default(0)

  totalTokens      BigInt @default(0)
  promptTokens     BigInt @default(0)
  completionTokens BigInt @default(0)

  totalCostUSD Decimal @default(0) @db.Decimal(10, 4)
  totalCostBRL Decimal @default(0) @db.Decimal(10, 4)

  avgDurationMs Int? // Dura√ß√£o m√©dia em ms
  p50DurationMs Int? // Percentil 50 (mediana)
  p95DurationMs Int? // Percentil 95
  p99DurationMs Int? // Percentil 99

  // RAG espec√≠fico
  ragRequestsCount  Int    @default(0)
  avgRagChunksCount Float? // M√©dia de chunks por requisi√ß√£o RAG

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // √çndices e constraints
  @@unique([organizationId, siteId, userId, period, periodStart, type, provider, model], name: "ai_metric_unique_idx")
  @@index([organizationId, period, periodStart], name: "ai_metric_org_period_idx")
  @@index([siteId, period, periodStart], name: "ai_metric_site_period_idx")
  @@index([periodStart, periodEnd], name: "ai_metric_period_range_idx")
  @@map("ai_metrics")
}

// üßæ 4. AIPrompt - Versionamento de prompts
model AIPrompt {
  id String @id @default(cuid())

  // Multi-tenancy (opcionais para permitir prompts globais, por organiza√ß√£o ou por site)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  siteId String?
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Identifica√ß√£o
  name        String // Nome do prompt (ex: "content_generation_blog_post")
  slug        String // Slug √∫nico (ex: "content-gen-blog-post")
  description String? // Descri√ß√£o do prompt

  // Versionamento
  version   Int     @default(1)
  isActive  Boolean @default(true)
  isDefault Boolean @default(false) // Vers√£o padr√£o para esta categoria

  // Conte√∫do
  prompt    String // Template do prompt
  variables String @default("[]") // JSON array - vari√°veis dispon√≠veis (ex: ["title", "keywords", "language"])

  // Configura√ß√µes recomendadas
  provider    String? // "openai", "gemini", "claude", etc (null = qualquer provider)
  model       String? // Modelo recomendado (null = qualquer modelo)
  temperature Float?  @default(0.7)
  maxTokens   Int?

  // Categoria
  category String // "content_generation", "rag_query", "diagnostic", "editing", "rewrite", etc

  // Metadados
  tags     String? // Tags separadas por v√≠rgula (ex: "blog,seo,pt-br")
  examples String? @default("[]") // JSON array - exemplos de uso

  // Auditoria
  createdBy     String? // userId que criou
  createdByUser User?   @relation("AIPromptCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)
  updatedBy     String? // userId que atualizou
  updatedByUser User?   @relation("AIPromptUpdatedBy", fields: [updatedBy], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // √çndices e constraints
  @@unique([slug, version], name: "ai_prompt_slug_version_idx")
  @@index([organizationId, siteId, category, isActive], name: "ai_prompt_org_site_category_idx")
  @@index([category, isDefault], name: "ai_prompt_category_default_idx")
  @@map("ai_prompts")
}

// ============================================
// FASE 6: CHAT SESSIONS E MENSAGENS
// ============================================

// üí¨ ChatSession - Sess√µes de conversa persistidas
model ChatSession {
  id String @id @default(cuid())

  // Multi-tenancy (OBRIGAT√ìRIO)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Metadados da sess√£o
  title    String? // T√≠tulo gerado automaticamente ou definido pelo usu√°rio
  metadata String? @default("{}") // JSON - metadados adicionais

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime? // √öltima mensagem na sess√£o

  // Relacionamentos
  messages ChatMessage[]

  // √çndices para performance e isolamento multi-tenant
  @@index([organizationId, siteId, createdAt], name: "chat_session_org_site_created_idx")
  @@index([userId, createdAt], name: "chat_session_user_created_idx")
  @@index([lastMessageAt], name: "chat_session_last_message_idx")
  @@map("chat_sessions")
}

// üí¨ ChatMessage - Mensagens individuais em uma sess√£o
model ChatMessage {
  id String @id @default(cuid())

  // Relacionamento com sess√£o (OBRIGAT√ìRIO)
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Conte√∫do da mensagem
  role    String // "system" | "user" | "assistant"
  content String // Conte√∫do da mensagem

  // Metadados de IA (quando role = "assistant")
  tokens          Int? // Tokens usados nesta mensagem
  provider        String? // "openai" | "gemini"
  model           String? // Modelo usado
  aiInteractionId String? // Refer√™ncia √† intera√ß√£o completa
  aiInteraction   AIInteraction? @relation(fields: [aiInteractionId], references: [id], onDelete: SetNull)

  // Metadados RAG (quando aplic√°vel)
  ragSources  String? @default("[]") // JSON array - fontes usadas no RAG
  ragMetadata String? @default("{}") // JSON - metadados do RAG (similaridade, chunks, etc)

  // Timestamps
  createdAt DateTime @default(now())

  // √çndices
  @@index([sessionId, createdAt], name: "chat_message_session_created_idx")
  @@index([aiInteractionId], name: "chat_message_ai_interaction_idx")
  @@map("chat_messages")
}

// üíæ AIResponseCache - Cache opcional de respostas (PostgreSQL)
model AIResponseCache {
  id String @id @default(cuid())

  // Multi-tenancy (OBRIGAT√ìRIO)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Cache key (hash da pergunta + contexto)
  cacheKey String

  // Resposta em cache
  response String // JSON da resposta completa

  // Metadados
  provider String // "openai" | "gemini"
  model    String // Modelo usado

  // Expira√ß√£o
  expiresAt DateTime

  // Estat√≠sticas
  hitCount Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // √çndices
  @@unique([organizationId, siteId, cacheKey], name: "ai_response_cache_key_tenant_idx")
  @@index([expiresAt], name: "ai_response_cache_expires_idx")
  @@index([organizationId, siteId, createdAt], name: "ai_response_cache_org_site_created_idx")
  @@map("ai_response_cache")
}

// ============================================
// FASE 7: EMBEDDING CHUNKS (RAG Melhorado)
// ============================================

// üß© EmbeddingChunk - Chunks menores e melhores para recupera√ß√£o
model EmbeddingChunk {
  id String @id @default(cuid())

  // Relacionamento com conte√∫do origem
  pageId String?
  page   Page?   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  aiContentId String?
  aiContent   AIContent? @relation(fields: [aiContentId], references: [id], onDelete: Cascade)

  templateId String?
  template   Template? @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // Multi-tenancy (OBRIGAT√ìRIO)
  siteId String
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  organizationId String // Denormalizado para performance
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Dados do chunk
  sourceType String // "page", "ai_content", "template"
  sourceId   String // ID do conte√∫do origem

  chunkIndex Int // √çndice do chunk no conte√∫do (0, 1, 2, ...)
  chunkText  String // Texto do chunk
  chunkHash  String // Hash SHA-256 do chunk (evita duplicatas)

  // Embedding (pgvector)
  embedding  Unsupported("vector(1536)") // pgvector
  model      String                      @default("text-embedding-ada-002")
  dimensions Int                         @default(1536)
  provider   String                      @default("openai")

  // Versionamento
  version  Int     @default(1)
  isActive Boolean @default(true)

  // Metadados
  language String @default("pt-BR")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // √çndices para performance e isolamento multi-tenant
  @@index([siteId, sourceType, sourceId, isActive], name: "embedding_chunk_site_source_active_idx")
  @@index([organizationId, siteId, sourceType], name: "embedding_chunk_org_site_source_idx")
  @@index([chunkHash, model, version], name: "embedding_chunk_hash_model_version_idx")
  @@index([sourceId, chunkIndex], name: "embedding_chunk_source_index_idx")
  @@map("embedding_chunks")
}

// FASE 8 ETAPA 4: Feedback de respostas da IA
model AIResponseFeedback {
  id String @id @default(cuid())

  // Multi-tenancy (OBRIGAT√ìRIO)
  organizationId String
  siteId         String

  // Relacionamento com intera√ß√£o (FK l√≥gica)
  aiInteractionId String

  // Usu√°rio (opcional)
  userId String?

  // Feedback
  rating     Int // +1 = positivo | -1 = negativo
  reason     String? // enum: INCORRECT, INCOMPLETE, CONFUSING, TOO_SLOW, TOO_GENERIC, HELPFUL, CLEAR, OTHER
  commentTag String? // opcional, categ√≥rico

  // Timestamps
  createdAt DateTime @default(now())

  // √çndices para performance e isolamento multi-tenant
  @@index([organizationId, siteId], name: "ai_feedback_org_site_idx")
  @@index([aiInteractionId], name: "ai_feedback_interaction_idx")
  @@index([rating], name: "ai_feedback_rating_idx")
  @@index([createdAt], name: "ai_feedback_created_at_idx")
  @@map("ai_response_feedback")
}
